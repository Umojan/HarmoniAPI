## Полный Flow: Email Verification + Stripe Payment + Resend Notifications (без Customer)

### Шаг 1: Email Верификация

User открывает страницу оплаты и вводит свой email. Frontend отправляет email на backend. Backend генерирует 6-значный код и отправляет его пользователю через Resend. Пользователь получает письмо с кодом. Пользователь вводит этот код обратно на странице. Frontend отправляет код на backend для проверки. Backend проверяет, что код совпадает, и помечает email как подтверждённый.

— Обратите внимание: этот шаг необходим для того, чтобы убедиться что пользователь реально владеет этим email адресом.

Backend генерирует уникальный код, хранит его временно (с TTL 10 минут), отправляет пользователю через Resend.

После верификации код удаляется и можно переходить к платежу.

### Шаг 2: Создание платежа в Stripe

После верификации email, frontend отправляет запрос на создание платежа вместе с подтверждённым email адресом.

Backend создаёт PaymentIntent без Customer - просто с суммой, валютой и email адресом в metadata (это просто текст для справки, который сохраняется вместе с платежом).

Backend возвращает client_secret на frontend.

### Шаг 3: Frontend показывает форму оплаты

Frontend получает client_secret и инициализирует Stripe Payment Element.

На странице появляется форма для ввода данных карты.

Пользователь вводит номер карты, срок действия и CVC.

Пользователь нажимает кнопку "Оплатить".

### Шаг 4: Stripe обрабатывает платёж

Frontend вызывает stripe.confirmPayment() с данными из Payment Element.

Stripe на своей стороне получает эти данные и токенизирует их (карта никогда не касается вашего сервера).

Stripe обрабатывает авторизацию платежа у банка.

Возможно требуется 3D Secure аутентификация (пользователь вводит пароль в банке).

Stripe обновляет статус PaymentIntent (succeeded или failed).

### Шаг 5: Результат платежа

Если карта простая (без 3D Secure): Stripe сразу возвращает результат на frontend, пользователь видит success сообщение на текущей странице.

Если требуется 3D Secure: Stripe редиректит пользователя на банковский сайт, пользователь проходит аутентификацию, банк редиректит обратно на вашу success страницу.

Независимо от того что видит пользователь, Stripe **всегда** отправляет webhook на ваш backend с результатом платежа.

### Шаг 6: Webhook и отправка email результата

Ваш backend слушает webhook endpoint и получает событие от Stripe.

Backend проверяет подпись webhook с помощью webhook_secret (чтобы убедиться что это действительно от Stripe).

**Если платеж успешен (payment_intent.succeeded):**
- Backend получает email из metadata платежа
- Backend сохраняет в БД: payment_id, email, сумма, статус "paid"
- Backend отправляет письмо через Resend с благодарностью и файлом (квитанция, счёт, доступ к услуге и т.д.)
- Пользователь получает письмо с прикреплённым файлом

**Если платеж не прошёл (payment_intent.payment_failed):**
- Backend получает email из metadata платежа
- Backend сохраняет в БД: payment_id, email, сумма, статус "failed"
- Backend отправляет письмо через Resend с объяснением ошибки
- Пользователь получает письмо об ошибке

Backend возвращает 200 OK Stripe.

### Шаг 7: Финальный статус на фронтенде

Пользователь находится на success странице.

Опционально: frontend может запросить у backend статус платежа.

Backend возвращает статус из БД (paid/failed).

Frontend показывает финальное сообщение пользователю.

---

Ключевые моменты:

Email верификация первая: Убедитесь что пользователь владеет email адресом ДО того как брать деньги
Карта никогда не касается вашего сервера: Все платёжные данные обрабатываются Stripe напрямую из браузера
Webhook - истина: Не полагайтесь на фронтенд. Webhook - это гарантированный способ узнать результат платежа
Email результата через Resend: Пользователь ВСЕГДА узнает результат (успех или ошибка) потому что вы отправите ему письмо
НУЖНО СОХРАНЯТЬ EMAIL. 